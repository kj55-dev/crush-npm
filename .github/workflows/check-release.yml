name: Check for new Crush releases

on:
  schedule:
    # Check daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check:
    name: Check for Crush updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Get current packaged version
        id: current
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Current packaged version: $VERSION"

      - name: Get latest Crush release
        id: latest
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=$(gh api repos/charmbracelet/crush/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=${LATEST}" >> $GITHUB_OUTPUT
          echo "Latest Crush version: $LATEST"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• New version available: $LATEST (currently packaging: $CURRENT)"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ“ Already up to date: $CURRENT"
          fi

      - name: Create update issue
        if: steps.compare.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.current.outputs.version }}';
            const latest = '${{ steps.latest.outputs.version }}';
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'update'
            });
            
            const existingIssue = issues.data.find(i => 
              i.title.includes(latest)
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ“¦ Update to Crush v${latest}`,
                body: `## New Crush Release Available
            
            A new version of Crush has been released by Charmbracelet.
            
            | | Version |
            |---|---------|
            | **Currently packaging** | v${current} |
            | **Latest available** | v${latest} |
            
            ## Action Required
            
            Run the [Publish workflow](../../actions/workflows/publish.yml) with version \`${latest}\` to update.
            
            ## Links
            
            - [Crush v${latest} Release Notes](https://github.com/charmbracelet/crush/releases/tag/v${latest})
            - [Crush Repository](https://github.com/charmbracelet/crush)
            
            ---
            *This issue was automatically created by the release checker workflow.*`,
                labels: ['update', 'automated']
              });
              
              console.log(`Created issue for Crush v${latest}`);
            } else {
              console.log(`Issue for v${latest} already exists`);
            }

      - name: Summary
        run: |
          echo "## Crush Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Currently packaging | v${{ steps.current.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest available | v${{ steps.latest.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.compare.outputs.needs_update }}" = "true" ]; then
            echo "ðŸ†• **Update available!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ“ **Up to date**" >> $GITHUB_STEP_SUMMARY
          fi
